# R1.5.9 Scene & Interaction Presets — Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add scene preset and interaction preset tables with seed data, CRUD APIs, select-influencer integration, and CastingAgent prompt rewrite for visual consistency across all 4 segments.

**Architecture:** Two new Supabase tables (`scene_preset`, `interaction_preset`) seeded with 7+10 system presets. Four new columns on `project` table (FK + override text for each). CRUD endpoints for both preset types. CastingAgent reads scene + interaction from project with priority chain (override > preset > legacy fallback). Consistency rule locks one scene across all segments.

**Tech Stack:** Supabase (PostgreSQL via MCP migrations), Next.js API routes, TypeScript

---

### Task 1: Create `scene_preset` Table + Seed 7 Presets

**Files:**
- Create via Supabase MCP: `scene_preset` table
- Seed data via `execute_sql`

**Step 1: Apply migration — create table**

```sql
CREATE TABLE scene_preset (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  title text NOT NULL,
  description text NOT NULL,
  category_affinity jsonb DEFAULT '[]'::jsonb,
  virality_notes text,
  is_default boolean DEFAULT false,
  is_custom boolean DEFAULT false,
  sort_order integer NOT NULL DEFAULT 0,
  created_at timestamptz DEFAULT now()
);

-- Only one default allowed
CREATE UNIQUE INDEX scene_preset_single_default
  ON scene_preset (is_default) WHERE is_default = true;

ALTER TABLE scene_preset ENABLE ROW LEVEL SECURITY;
CREATE POLICY "scene_preset_read_all" ON scene_preset FOR SELECT USING (true);
CREATE POLICY "scene_preset_insert_custom" ON scene_preset FOR INSERT WITH CHECK (is_custom = true);
CREATE POLICY "scene_preset_delete_custom" ON scene_preset FOR DELETE USING (is_custom = true);
```

**Step 2: Seed 7 system presets via `execute_sql`**

Insert all 7 presets from the design spec with `is_custom = false`.

**Step 3: Verify**

Run: `execute_sql` → `SELECT title, is_default, sort_order FROM scene_preset ORDER BY sort_order`
Expected: 7 rows, "Bedroom Ring Light" is the only `is_default = true`

---

### Task 2: Create `interaction_preset` Table + Seed 10 Presets

**Files:**
- Create via Supabase MCP: `interaction_preset` table
- Seed data via `execute_sql`

**Step 1: Apply migration — create table**

```sql
CREATE TABLE interaction_preset (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  title text NOT NULL,
  description text NOT NULL,
  category_affinity jsonb DEFAULT '[]'::jsonb,
  is_default boolean DEFAULT false,
  is_custom boolean DEFAULT false,
  sort_order integer NOT NULL DEFAULT 0,
  created_at timestamptz DEFAULT now()
);

CREATE UNIQUE INDEX interaction_preset_single_default
  ON interaction_preset (is_default) WHERE is_default = true;

ALTER TABLE interaction_preset ENABLE ROW LEVEL SECURITY;
CREATE POLICY "interaction_preset_read_all" ON interaction_preset FOR SELECT USING (true);
CREATE POLICY "interaction_preset_insert_custom" ON interaction_preset FOR INSERT WITH CHECK (is_custom = true);
CREATE POLICY "interaction_preset_delete_custom" ON interaction_preset FOR DELETE USING (is_custom = true);
```

**Step 2: Seed 10 system presets via `execute_sql`**

Insert all 10 presets from the design spec with `is_custom = false`.

**Step 3: Verify**

Run: `execute_sql` → `SELECT title, is_default, sort_order FROM interaction_preset ORDER BY sort_order`
Expected: 10 rows, "Hold & Show" is the only `is_default = true`

---

### Task 3: Add Scene + Interaction Columns to `project` Table

**Files:**
- Supabase MCP migration on `project` table

**Step 1: Apply migration**

```sql
ALTER TABLE project
  ADD COLUMN scene_preset_id uuid REFERENCES scene_preset(id),
  ADD COLUMN scene_override text,
  ADD COLUMN interaction_preset_id uuid REFERENCES interaction_preset(id),
  ADD COLUMN interaction_override text;
```

**Step 2: Verify**

Run: `execute_sql` → `SELECT column_name, data_type FROM information_schema.columns WHERE table_name = 'project' AND column_name LIKE '%scene%' OR column_name LIKE '%interaction%'`
Expected: 4 new columns visible

---

### Task 4: Scene Presets CRUD API

**Files:**
- Create: `src/app/api/scene-presets/route.ts`
- Create: `src/app/api/scene-presets/[id]/route.ts`

**Step 1: Create GET + POST endpoint**

`src/app/api/scene-presets/route.ts`:
- `GET /api/scene-presets` — returns all presets ordered by `sort_order`. If `?category=X` query param, sort by category affinity (matching category first).
- `POST /api/scene-presets` — creates custom preset. Requires `{ title, description }`. Auto-sets `is_custom=true`, `sort_order` to max+1.

**Step 2: Create DELETE endpoint**

`src/app/api/scene-presets/[id]/route.ts`:
- `DELETE /api/scene-presets/[id]` — deletes custom preset. Returns 409 if `is_custom=false` (system presets are immutable).

**Step 3: Verify**

Run: `curl GET /api/scene-presets` → 7 presets returned
Run: `curl POST /api/scene-presets` with `{ title: "Test", description: "Test scene" }` → created with `is_custom=true`
Run: `curl DELETE /api/scene-presets/<system-id>` → 409 error

---

### Task 5: Interaction Presets CRUD API

**Files:**
- Create: `src/app/api/interaction-presets/route.ts`
- Create: `src/app/api/interaction-presets/[id]/route.ts`

**Step 1: Create GET + POST endpoint**

`src/app/api/interaction-presets/route.ts`:
- `GET /api/interaction-presets` — same pattern as scene presets. Optional `?category=X`.
- `POST /api/interaction-presets` — creates custom preset with `is_custom=true`.

**Step 2: Create DELETE endpoint**

`src/app/api/interaction-presets/[id]/route.ts`:
- `DELETE /api/interaction-presets/[id]` — deletes custom preset. 409 for system presets.

**Step 3: Verify**

Run: `curl GET /api/interaction-presets` → 10 presets returned

---

### Task 6: Update `select-influencer` API to Accept Scene + Interaction

**Files:**
- Modify: `src/app/api/projects/[id]/select-influencer/route.ts`

**Step 1: Extend request body parsing**

Accept new fields: `scenePresetId`, `sceneOverride`, `interactionPresetId`, `interactionOverride`.

**Step 2: Add to project update**

Add scene/interaction fields to the `updateData` object that gets written to the project.

**Step 3: Default handling**

If neither `scenePresetId` nor `sceneOverride` provided, look up the default scene preset (`is_default=true`) and set it.
Same for interaction presets.

**Step 4: Verify**

The endpoint should accept the new fields and store them on the project row.

---

### Task 7: Rewrite CastingAgent Scene + Interaction Prompts

**Files:**
- Modify: `src/agents/casting-agent.ts` (lines 60-64 for setting lookup, lines 225-252 for prompt construction)

**Step 1: Fetch scene + interaction data**

After fetching the project (line 20-26), also fetch scene_preset and interaction_preset if IDs are set on the project.

Priority chain for scene:
1. `project.scene_override` (custom text)
2. `scene_preset.description` (via `project.scene_preset_id`)
3. `avatarFallback.setting` (legacy fallback)

Priority chain for interaction:
1. `project.interaction_override` (custom text)
2. `interaction_preset.description` (via `project.interaction_preset_id`)
3. Current `PRODUCT_PLACEMENT_ARC` description (legacy — no change)

**Step 2: Rewrite `generateVisualPrompts` to use scene + interaction**

Replace `Setting: ${setting}` in both edit and non-edit prompts with:
```
Scene: ${sceneDescription}
Product interaction: ${interactionDescription}

CONSISTENCY RULE: All 4 segments MUST use the same room, lighting setup, and props.
Only vary: character pose, energy level, product visibility, and camera micro-adjustments
(slight angle shift, subtle lighting warmth change matching energy arc).
The video must look like one continuous shoot in one location.
```

**Step 3: Update template fallback**

The fallback prompt at line 278 also needs to use `sceneDescription` instead of `setting`.

**Step 4: Verify**

Run: `npm run build` — no type errors

---

### Task 8: Update Roadmap Checkboxes

**Files:**
- Modify: `docs/ENGINEERING_ROADMAP.md`

**Step 1: Check off completed backend items**

Mark all 7 backend checkboxes for R1.5.9 as done.

**Step 2: Commit and push**
