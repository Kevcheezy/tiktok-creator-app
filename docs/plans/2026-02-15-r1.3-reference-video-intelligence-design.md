# R1.3 Reference Video Intelligence — Design Document

**Date:** 2026-02-15
**Status:** Approved
**Roadmap item:** R1.3 (Tier 1, P0 Critical)
**Effort:** Medium

---

## Goal

Build a VideoAnalysisAgent that downloads and analyzes reference TikTok videos using the SEAL method (Scene, Emotion, Angle, Lighting), extracts structured per-segment data optimized for Nano Banana Pro keyframe generation, and strongly influences ScriptingAgent and CastingAgent output to match the reference video's proven viral patterns.

## Architecture

VideoAnalysisAgent runs in parallel with ProductAnalyzerAgent during the `analyzing` pipeline step. It downloads the reference video via `yt-dlp`, uploads to Supabase Storage, sends to Google Gemini 2.5 Flash for multimodal analysis, and stores a structured SEAL breakdown as `video_analysis` JSONB on the project record. Downstream agents (ScriptingAgent, CastingAgent) read this data and strongly incorporate it — the reference video's structure dominates the generated output while the tone preset and product data provide content.

**New dependencies:**
- `@google/generative-ai` npm package (Gemini SDK)
- `yt-dlp` CLI tool (installed on Railway worker)
- `GOOGLE_API_KEY` environment variable

---

## Data Model

### Migration: Add `video_analysis` column to `project`

```sql
ALTER TABLE project ADD COLUMN video_analysis jsonb;
```

### VideoAnalysis JSONB Schema

```typescript
interface VideoAnalysis {
  // Hook analysis (first 3-5 seconds)
  hook: {
    type: string;              // "question" | "shocking-stat" | "controversy" | "curiosity-gap" | "before-after" | "direct-address"
    technique: string;         // What makes the hook work
    text: string;              // Transcribed hook text
    durationSeconds: number;
  };

  // SEAL breakdown per segment (4 segments, ~15s each)
  segments: Array<{
    index: number;             // 0-3
    startTime: number;         // seconds
    endTime: number;           // seconds

    // S — Scene
    scene: {
      setting: string;         // "modern kitchen", "bedroom vanity", "outdoor patio"
      props: string[];         // ["product on counter", "mirror", "ring light"]
      composition: string;     // "subject center-frame", "product in foreground"
      productPresence: string; // "none" | "subtle" | "prominent" | "hero"
    };

    // E — Emotion
    emotion: {
      mood: string;            // "excited", "skeptical", "surprised", "calm"
      energy: string;          // "low" | "medium" | "high" | "peak"
      pacing: string;          // "slow" | "moderate" | "fast" | "rapid"
      viewerIntent: string;    // "curiosity", "trust", "desire", "urgency"
    };

    // A — Angle
    angle: {
      shotType: string;        // "close-up" | "medium" | "wide" | "extreme-close-up" | "product-insert"
      cameraMovement: string;  // "static" | "slow-zoom-in" | "pan" | "handheld" | "tracking"
      transitions: string;     // "hard-cut" | "smooth" | "jump-cut" | "swipe"
    };

    // L — Lighting
    lighting: {
      style: string;           // "natural-window" | "ring-light" | "studio" | "dramatic" | "golden-hour"
      colorTemp: string;       // "warm" | "cool" | "neutral"
      contrast: string;        // "soft" | "medium" | "high"
    };

    description: string;       // Brief narrative of what happens
  }>;

  // Overall analysis
  overall: {
    energyArc: string;         // "build-to-peak" | "peak-valley-peak" | "steady-high" | "slow-burn"
    dominantStyle: string;     // Free-text summary of visual identity
    musicPresence: boolean;
    textOverlayStyle: string;  // "none" | "minimal-captions" | "bold-headlines" | "animated"
    estimatedDuration: number; // total seconds
    viralPattern: string;      // What makes this video likely to perform
  };
}
```

Each segment's SEAL data translates directly into a Nano Banana Pro keyframe prompt:
```
"[Scene.setting], [Scene.composition]. Subject showing [Emotion.mood] energy.
[Angle.shotType] shot, [Angle.cameraMovement]. [Lighting.style] lighting,
[Lighting.colorTemp] tones. [Scene.productPresence] product placement."
```

---

## Components

### 1. Gemini API Client

**File:** `src/lib/api-clients/gemini.ts`

```typescript
export class GeminiClient {
  constructor(apiKey?: string)
  async analyzeVideo(filePath: string, systemPrompt: string, userPrompt: string): Promise<string>
  // 1. Upload video via fileManager.uploadFile()
  // 2. Wait for file processing (poll until ACTIVE)
  // 3. Send to generateContent() with video file + text prompts
  // 4. Return text response
}
```

Uses `@google/generative-ai` SDK. Model: `gemini-2.5-flash`.

### 2. VideoAnalysisAgent

**File:** `src/agents/video-analysis-agent.ts`

Extends `BaseAgent`. Flow:

1. Read `project.video_url` from DB
2. Download video to `/tmp/{projectId}-reference.mp4` via `yt-dlp` (child_process.execFile)
   - 30s timeout
   - Max 100MB file size
   - Format: best mp4, max 720p (keep file small for Gemini upload)
3. Upload to Supabase Storage: `assets/projects/{projectId}/reference.mp4`
4. Send to Gemini via `GeminiClient.analyzeVideo()` with SEAL-structured prompt
5. Parse JSON response, validate structure
6. Store `video_analysis` JSONB on the project record
7. Track cost (~$0.02 via `this.trackCost()`)
8. Clean up temp file

**Error handling:** If download or analysis fails, log the error, set `video_analysis = null`, continue pipeline. Video analysis is valuable but not blocking.

### 3. Pipeline Worker Changes

**File:** `src/workers/pipeline.worker.ts`

In the `product_analysis` handler:

```typescript
case 'product_analysis': {
  const analyzerAgent = new ProductAnalyzerAgent(supabase, wavespeed);
  const videoAgent = new VideoAnalysisAgent(supabase, wavespeed);

  const tasks = [analyzerAgent.run(projectId)];

  if (project.video_url) {
    tasks.push(videoAgent.run(projectId));
  }

  const results = await Promise.allSettled(tasks);
  // Product analysis failure = pipeline failure
  // Video analysis failure = log warning, continue
}
```

### 4. ScriptingAgent Integration

**File:** `src/agents/scripting-agent.ts`

When building the user prompt, if `project.video_analysis` exists:

- **Replace** the current `REFERENCE VIDEO (analyze structure): ${videoUrl}` line
- **Add** a rich structured block with SEAL data per segment
- **Instruction:** "Your script should strongly match this reference video's hook style, energy arc, pacing, and segment structure. Adapt content for the current product while preserving the reference's proven viral pattern."
- The reference video structure **dominates** — tone preset provides flavor, not structure

### 5. CastingAgent Integration

**File:** `src/agents/casting-agent.ts`

When building keyframe generation prompts, if `video_analysis` exists:

- For each segment, pull SEAL data from `video_analysis.segments[i]`
- Incorporate Scene (setting, composition), Angle (shot type), and Lighting (style, color temp) into the image prompt
- This ensures keyframes visually match the reference video's aesthetic

### 6. Frontend — Analysis Review

**File:** `src/components/project-detail.tsx` (analysis_review state)

When `video_analysis` exists:
- Embedded video player for the reference video (from Supabase Storage URL)
- SEAL breakdown cards per segment below the player
- Side-by-side layout: reference video analysis (left) + product analysis (right)

### 7. Frontend — Completed State

**File:** `src/components/project-detail.tsx` (completed state)

If reference video was used:
- "Reference vs Generated" comparison section
- Reference video player alongside the final generated video

---

## Cost Impact

| Item | Cost |
|------|------|
| Gemini 2.5 Flash video analysis | ~$0.01-0.02 |
| yt-dlp download | Free |
| Supabase Storage (~50MB video) | Negligible |
| **Total added cost per video** | **~$0.02** |

Updated per-video cost: **~$5.60** (from ~$5.58)

---

## New Environment Variables

| Variable | Where | Description |
|----------|-------|-------------|
| `GOOGLE_API_KEY` | Vercel + Railway | Google AI Studio API key for Gemini |

---

## Roadmap Coverage

| Roadmap Item | Design Coverage |
|--------------|----------------|
| Video analysis agent: Download and analyze reference TikTok videos | VideoAnalysisAgent + yt-dlp + Gemini |
| Extract pacing, hook style, energy arc, visual composition | SEAL framework (Scene, Emotion, Angle, Lighting) |
| Feed reference analysis into ScriptingAgent | Strong influence: SEAL data in prompt, structure dominates |
| Feed reference analysis into DirectorAgent/CastingAgent | SEAL data → keyframe prompts for Nano Banana Pro |
| UI: Show reference video alongside generated output | Analysis review + completed state comparison views |
