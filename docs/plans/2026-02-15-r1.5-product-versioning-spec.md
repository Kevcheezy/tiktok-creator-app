# R1.5 — Product Versioning Spec

**Date:** 2026-02-15
**Status:** Draft — awaiting review
**Priority:** P0 (dependency for R1.4 Observability)
**Effort:** Small
**Depends on:** Nothing
**Blocks:** R1.4 (Observability needs version context in logs)

## Problem

The app has no versioning infrastructure. There's no way to tell which version is deployed, no version context in logs or errors, and no git tagging strategy. When debugging production issues, there's no way to correlate behavior to a specific release.

## Current State

- `package.json` has `"version": "0.1.0"` — never been bumped
- 80 `console.log/error` calls across 29 files — none include version
- No `/api/version` endpoint
- No version displayed in the UI
- No git tags
- No build-time version injection (no `APP_VERSION` env var)
- Worker logs startup with no version context

## What "Done" Looks Like

### 1. Version Source of Truth
- **File:** `src/lib/version.ts`
- Exports `APP_VERSION` (from package.json), `GIT_COMMIT` (from env), `BUILD_TIME` (from env), `ENVIRONMENT` (from env)
- Build-time values fall back gracefully in dev (e.g., `GIT_COMMIT` = `'dev'` when not set)

### 2. Version API Endpoint
- **File:** `src/app/api/version/route.ts`
- `GET /api/version` returns:
  ```json
  {
    "version": "0.1.0",
    "commit": "abc1234",
    "environment": "production",
    "buildTime": "2026-02-15T12:00:00Z"
  }
  ```
- No auth required (public health check)

### 3. Version in UI
- Display version in the nav bar (`src/components/nav.tsx`) — small, unobtrusive, e.g. `v0.1.0` in the corner
- Links to `/api/version` or shows a tooltip with commit hash on hover

### 4. Version in Worker Logs
- Worker startup log includes version: `Pipeline worker v0.1.0 (abc1234) starting...`
- Worker error logs include version context

### 5. Build-Time Injection
- **next.config.ts:** Inject `APP_VERSION`, `GIT_COMMIT`, `BUILD_TIME` as env vars at build time
- Vercel: Use `VERCEL_GIT_COMMIT_SHA` for commit hash (auto-provided)
- Railway: Use `RAILWAY_GIT_COMMIT_SHA` for commit hash (auto-provided)
- Fallback to `'dev'` / `'unknown'` locally

### 6. Git Tagging
- Bump `package.json` version to `0.2.0` (first real release with versioning)
- Create git tag `v0.2.0` after implementation is merged
- Document tagging convention: `v{MAJOR}.{MINOR}.{PATCH}`

## Acceptance Criteria

- [ ] `src/lib/version.ts` exists and exports `APP_VERSION`, `GIT_COMMIT`, `BUILD_TIME`, `ENVIRONMENT`
- [ ] `GET /api/version` returns JSON with version, commit, environment, buildTime
- [ ] Nav bar shows current version (small text)
- [ ] Worker startup log includes version and commit hash
- [ ] `next.config.ts` injects version env vars at build time
- [ ] `package.json` version bumped to `0.2.0`
- [ ] `npm run build` passes
- [ ] `npm run worker` starts with version in log output
- [ ] Git tag `v0.2.0` created

## Files Affected

| File | Action | Agent |
|------|--------|-------|
| `src/lib/version.ts` | Create | Backend |
| `src/app/api/version/route.ts` | Create | Backend |
| `next.config.ts` | Modify | Backend |
| `package.json` | Modify (version bump) | Backend |
| `src/workers/pipeline.worker.ts` | Modify (add version to startup log) | Backend |
| `src/components/nav.tsx` | Modify (show version) | Frontend |

## PARALLEL WORK ANALYSIS

- **Task A (backend):** Create version module, API endpoint, build-time injection, worker log update, version bump
  - Files: `src/lib/version.ts`, `src/app/api/version/route.ts`, `next.config.ts`, `package.json`, `src/workers/pipeline.worker.ts`
- **Task B (frontend):** Display version in nav bar
  - Files: `src/components/nav.tsx`
  - BLOCKED by Task A — needs `src/lib/version.ts` to import the version constant

**Recommendation:** Sequential — backend first, then frontend. Task B depends on the version module from Task A.

## Out of Scope

- Structured logging (R1.4 — separate spec)
- `generation_log` database table (R1.4)
- `app_version` column on existing tables (R1.4)
- Automated version bumping / CI release pipeline (Tier 3)
