# R1.5.10 Visual Script Breakdown — Backend Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Auto-tag script segments with props/interaction type and add editable camera specs, completing the R1.5.10 backend.

**Architecture:** Extend ScriptingAgent LLM output format to include 3 new fields per segment (props_needed, interaction_type, camera_specs). Add 3 columns to scene table. Make them editable via PATCH. Feed camera_specs into CastingAgent visual prompts.

**Tech Stack:** Supabase (PostgreSQL), Next.js API routes, WaveSpeed LLM

---

### Task 1: Add columns to scene table

**Files:**
- Supabase migration (via MCP)

**Step 1: Apply migration**

Add 3 new columns to `scene` table:

```sql
ALTER TABLE scene
  ADD COLUMN IF NOT EXISTS props_needed jsonb DEFAULT '[]'::jsonb,
  ADD COLUMN IF NOT EXISTS interaction_type text DEFAULT NULL,
  ADD COLUMN IF NOT EXISTS camera_specs jsonb DEFAULT NULL;
```

**Step 2: Verify**

```sql
SELECT column_name, data_type FROM information_schema.columns
WHERE table_name = 'scene' AND column_name IN ('props_needed', 'interaction_type', 'camera_specs');
```

Expected: 3 rows returned.

---

### Task 2: Add validation constants

**Files:**
- Modify: `src/lib/constants.ts`

**Step 1: Add enum arrays**

Add after `PRODUCT_PLACEMENT_ARC`:

```typescript
export const INTERACTION_TYPES = [
  'hold_and_show', 'apply_to_skin', 'stir_mix', 'demonstrate',
  'pour_drink', 'unbox', 'compare', 'try_on', 'set_down_point', 'none',
] as const;
export type InteractionType = typeof INTERACTION_TYPES[number];

export const CAMERA_ANGLES = ['close-up', 'medium', 'wide', 'over-shoulder'] as const;
export type CameraAngle = typeof CAMERA_ANGLES[number];

export const CAMERA_MOVEMENTS = ['static', 'slow_zoom_in', 'slow_zoom_out', 'pan_left', 'pan_right', 'tracking'] as const;
export type CameraMovement = typeof CAMERA_MOVEMENTS[number];

export const LIGHTING_DIRECTIONS = ['ring_light_front', 'natural_window', 'warm_ambient', 'dramatic_side', 'soft_diffused'] as const;
export type LightingDirection = typeof LIGHTING_DIRECTIONS[number];
```

**Step 2: Verify build**

Run: `npm run build`

---

### Task 3: Update ScriptingAgent LLM output format

**Files:**
- Modify: `src/agents/scripting-agent.ts`

**Step 1: Update Segment interface**

Add to the `Segment` interface (around line 40-51):

```typescript
interface Segment {
  // ... existing fields ...
  broll_cues?: BrollCue[];
  props_needed?: string[];
  interaction_type?: string;
  camera_specs?: {
    angle: string;
    movement: string;
    lighting: string;
  };
}
```

**Step 2: Update system prompt output format**

In `buildSystemPrompt()`, add to the RULES section (after rule 7 B-ROLL TIMING CUES):

```
8. SEGMENT TAGGING (REQUIRED for each segment):
   Tag each segment with production metadata:
   - props_needed: array of physical props visible in this segment (e.g., ["product bottle", "cotton pad", "mirror"])
   - interaction_type: how the creator interacts with the product. One of: hold_and_show, apply_to_skin, stir_mix, demonstrate, pour_drink, unbox, compare, try_on, set_down_point, none
   - camera_specs: shot composition details:
     - angle: one of close-up, medium, wide, over-shoulder
     - movement: one of static, slow_zoom_in, slow_zoom_out, pan_left, pan_right, tracking
     - lighting: one of ring_light_front, natural_window, warm_ambient, dramatic_side, soft_diffused

9. SEGMENT TAGGING RULES:
   - Segment 1 (Hook): interaction_type MUST be "none" (no product visible)
   - Segment 3 (Solution): interaction_type MUST NOT be "none" (product is the hero)
   - Props should include the product name when product_visibility is not "none"
   - Camera should progress: medium/wide for hook → close-up for product hero → medium for CTA
```

And add these fields to the JSON output example in the system prompt:

```json
"props_needed": ["product bottle", "cotton pad"],
"interaction_type": "apply_to_skin",
"camera_specs": { "angle": "close-up", "movement": "slow_zoom_in", "lighting": "ring_light_front" }
```

**Step 3: Update the analysis system prompt**

Apply the same additions to the `analysisSystemPrompt` in `analyzeUploadedScript()`.

**Step 4: Update the regenerateSegment output format**

Add the 3 new fields to the single-segment JSON output template in `regenerateSegment()`.

**Step 5: Update scene row inserts**

In `run()` (line ~262), add to sceneRows mapping:

```typescript
props_needed: seg.props_needed || [],
interaction_type: seg.interaction_type || null,
camera_specs: seg.camera_specs || null,
```

Same in `analyzeUploadedScript()` (line ~476).

**Step 6: Update regenerateSegment scene insert**

In `regenerateSegment()` (line ~715), add to the insert:

```typescript
props_needed: segment.props_needed || [],
interaction_type: segment.interaction_type || null,
camera_specs: segment.camera_specs || null,
```

And capture these from parsed response:

```typescript
const segment: Segment = {
  // ... existing fields ...
  props_needed: parsed.props_needed,
  interaction_type: parsed.interaction_type,
  camera_specs: parsed.camera_specs,
};
```

**Step 7: Verify build**

Run: `npm run build`

---

### Task 4: Update segment PATCH endpoint

**Files:**
- Modify: `src/app/api/projects/[id]/scripts/[scriptId]/segments/[segmentIndex]/route.ts`

**Step 1: Add validation imports and field handling**

Add to the PATCH handler — extend the body field checks:

```typescript
import { INTERACTION_TYPES, CAMERA_ANGLES, CAMERA_MOVEMENTS, LIGHTING_DIRECTIONS } from '@/lib/constants';

const hasPropsNeeded = 'props_needed' in body && Array.isArray(body.props_needed);
const hasInteractionType = 'interaction_type' in body && typeof body.interaction_type === 'string';
const hasCameraSpecs = 'camera_specs' in body && typeof body.camera_specs === 'object' && body.camera_specs !== null;
```

Update the "no valid fields" check to include the new fields.

**Step 2: Add enum validation**

Before the scene insert, validate:

```typescript
if (hasInteractionType) {
  const validTypes: readonly string[] = INTERACTION_TYPES;
  if (!validTypes.includes(body.interaction_type)) {
    return NextResponse.json(
      { error: `Invalid interaction_type. Must be one of: ${INTERACTION_TYPES.join(', ')}` },
      { status: 400 }
    );
  }
}

if (hasCameraSpecs) {
  const { angle, movement, lighting } = body.camera_specs;
  const validAngles: readonly string[] = CAMERA_ANGLES;
  const validMovements: readonly string[] = CAMERA_MOVEMENTS;
  const validLighting: readonly string[] = LIGHTING_DIRECTIONS;

  if (angle && !validAngles.includes(angle)) {
    return NextResponse.json({ error: `Invalid camera angle. Must be one of: ${CAMERA_ANGLES.join(', ')}` }, { status: 400 });
  }
  if (movement && !validMovements.includes(movement)) {
    return NextResponse.json({ error: `Invalid camera movement. Must be one of: ${CAMERA_MOVEMENTS.join(', ')}` }, { status: 400 });
  }
  if (lighting && !validLighting.includes(lighting)) {
    return NextResponse.json({ error: `Invalid lighting direction. Must be one of: ${LIGHTING_DIRECTIONS.join(', ')}` }, { status: 400 });
  }
}
```

**Step 3: Include new fields in scene insert**

```typescript
props_needed: hasPropsNeeded ? body.props_needed : currentScene.props_needed,
interaction_type: hasInteractionType ? body.interaction_type : currentScene.interaction_type,
camera_specs: hasCameraSpecs ? { ...currentScene.camera_specs, ...body.camera_specs } : currentScene.camera_specs,
```

Note: camera_specs uses spread merge so you can update individual fields (e.g., just angle) without losing movement/lighting.

**Step 4: Verify build**

Run: `npm run build`

---

### Task 5: Feed camera_specs into CastingAgent

**Files:**
- Modify: `src/agents/casting-agent.ts`

**Step 1: Add camera_specs to visual prompt generation**

In `generateVisualPrompts()`, read camera_specs from the scene and include in the LLM prompt:

After the scene/interaction description block, add:

```typescript
const cameraSpecs = scene.camera_specs as { angle?: string; movement?: string; lighting?: string } | null;
if (cameraSpecs) {
  enrichedUserPrompt += `\nCamera: ${cameraSpecs.angle || 'medium'} shot, ${cameraSpecs.movement || 'static'}, ${cameraSpecs.lighting || 'natural_window'} lighting`;
}
```

Also add to the template fallback:

```typescript
const cameraStr = cameraSpecs
  ? `${cameraSpecs.angle || 'medium'} shot, ${cameraSpecs.movement || 'static'}, ${cameraSpecs.lighting || 'natural_window'} lighting`
  : 'medium shot, static, cinematic lighting';
```

**Step 2: Verify build**

Run: `npm run build`

---

### Task 6: Update roadmap and commit

**Files:**
- Modify: `docs/ENGINEERING_ROADMAP.md`

**Step 1: Check off completed items**

Change:
```
- [ ] Auto-tag script segments with: props needed, interaction type (requires backend tagging)
- [ ] Camera/shot specs surfaced as editable fields: angle (close-up/medium/wide), movement (static/pan/zoom), lighting direction
```

To:
```
- [x] Auto-tag script segments with: props needed, interaction type (requires backend tagging)
- [x] Camera/shot specs surfaced as editable fields: angle (close-up/medium/wide), movement (static/pan/zoom), lighting direction
```

Update header to `~~DONE~~` if all items are now checked.

**Step 2: Commit and push**

```bash
git add -A
git commit -m "feat(r1.5.10): auto-tag segments with props/interaction + editable camera specs"
git push
```
