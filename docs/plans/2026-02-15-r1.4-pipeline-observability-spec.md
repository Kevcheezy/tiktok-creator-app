# R1.4 — Pipeline Observability & Logging Spec

**Date:** 2026-02-15
**Status:** Draft — awaiting review
**Priority:** P0 (debugging foundation for pipeline hardening)
**Effort:** Medium
**Depends on:** ~~R1.5~~ (done — version context available)
**Blocks:** R1.1 benefits from this (debugging pipeline issues)

## Problem

The app has ~90 unstructured `console.log/error` calls across 29 files. When a pipeline fails in production:
- Logs are plain text with no severity, timestamps, or structured metadata
- No way to correlate logs across a single pipeline run (worker → agent → API client)
- No persistent record of what happened — only `project.error_message` survives
- External API calls (WaveSpeed, ElevenLabs, Creatomate) have zero visibility into request/response details, latencies, or costs per call
- No way to answer "what took so long?" or "which API call failed?" after the fact

## What "Done" Looks Like

### 1. Pino Structured Logger
- **Install:** `pino` (production logger) + `pino-pretty` (dev formatting)
- **File:** `src/lib/logger.ts` — Create a shared logger factory
- Exports a `createLogger(context)` function that returns a Pino child logger
- Every log entry includes: `version`, `commit`, `environment`, `timestamp`, `level`
- Child loggers add context: `projectId`, `agentName`, `jobId`, `correlationId`
- In dev: pretty-printed with colors. In production: JSON (for log aggregation services)

### 2. Correlation IDs
- Generate a `correlationId` (UUID) when a pipeline job starts in the worker
- Pass it through: worker → agent.run() → API client calls
- Every log line for a pipeline run shares the same `correlationId`
- Allows filtering all logs for a single pipeline execution

### 3. Replace console.log/error
- **Worker** (`pipeline.worker.ts`): Replace all `console.log/error` with structured logger
- **Base Agent** (`base-agent.ts`): Replace `this.log()` to use Pino child logger with `agentName` + `projectId` + `correlationId`
- **API Clients** (`api-clients/*.ts`): Log every external API call with: method, URL, status code, latency (ms), cost if applicable
- **API Routes** (`app/api/**/*.ts`): Replace `console.error` with structured logger including route path

### 4. generation_log Database Table
- **Via Supabase MCP migration**
- Stores key pipeline events persistently (not every log line — just the important ones)
- Schema:
  ```sql
  create table generation_log (
    id uuid default gen_random_uuid() primary key,
    project_id uuid references project(id) on delete cascade,
    correlation_id uuid,
    event_type text not null,        -- 'stage_start', 'stage_complete', 'stage_error', 'api_call', 'cost'
    agent_name text,                 -- 'ProductAnalyzerAgent', 'CastingAgent', etc.
    stage text,                      -- 'analyzing', 'scripting', 'casting', etc.
    detail jsonb,                    -- Flexible payload: { url, status, latency_ms, error, cost_usd, ... }
    app_version text,
    created_at timestamptz default now()
  );

  create index idx_generation_log_project on generation_log(project_id);
  create index idx_generation_log_correlation on generation_log(correlation_id);
  ```
- Events logged to this table:
  - Pipeline stage start/complete/error (with timing)
  - Each external API call (provider, endpoint, status, latency, cost)
  - Total cost accumulation per stage

### 5. API Call Audit Trail in API Clients
- Wrap each external API call with timing + logging
- Log: `{ provider, endpoint, method, statusCode, latencyMs, costUsd, error }`
- Also write to `generation_log` table when a `projectId` is in context
- Retry attempts logged with attempt number

## Acceptance Criteria

- [ ] `pino` and `pino-pretty` added to package.json
- [ ] `src/lib/logger.ts` exists with `createLogger(context)` factory
- [ ] All `console.log/error` in worker replaced with structured logger
- [ ] All `console.log/error` in agents replaced (via BaseAgent)
- [ ] All `console.log/error` in API clients replaced with call audit logging
- [ ] All `console.error` in API routes replaced with structured logger
- [ ] Correlation ID generated per pipeline job and threaded through all calls
- [ ] `generation_log` table created via Supabase migration
- [ ] Pipeline stage start/complete/error events written to `generation_log`
- [ ] External API calls logged to `generation_log` with latency + cost
- [ ] Dev mode shows pretty-printed colored logs
- [ ] Production mode outputs JSON logs
- [ ] `npm run build` passes
- [ ] Worker starts with structured startup log

## Files Affected

| File | Action | Agent | Notes |
|------|--------|-------|-------|
| `package.json` | Modify | Backend | Add pino, pino-pretty |
| `src/lib/logger.ts` | Create | Backend | Logger factory |
| `src/agents/base-agent.ts` | Modify | Backend | Replace this.log() with Pino |
| `src/agents/product-analyzer.ts` | Modify | Backend | Accept correlationId |
| `src/agents/scripting-agent.ts` | Modify | Backend | Accept correlationId |
| `src/agents/casting-agent.ts` | Modify | Backend | Accept correlationId |
| `src/agents/director-agent.ts` | Modify | Backend | Accept correlationId |
| `src/agents/voiceover-agent.ts` | Modify | Backend | Accept correlationId |
| `src/agents/editor-agent.ts` | Modify | Backend | Accept correlationId |
| `src/lib/api-clients/wavespeed.ts` | Modify | Backend | Add call audit logging |
| `src/lib/api-clients/elevenlabs.ts` | Modify | Backend | Add call audit logging |
| `src/lib/api-clients/creatomate.ts` | Modify | Backend | Add call audit logging |
| `src/workers/pipeline.worker.ts` | Modify | Backend | Structured logging + correlationId |
| `src/app/api/**/*.ts` | Modify | Backend | Replace console.error (~22 files) |
| `generation_log` table | Create | Backend (Supabase MCP) | New table + indexes |

## PARALLEL WORK ANALYSIS

This is **entirely backend work** — no frontend changes needed.

However, within backend, there are dependency chains:

```
Phase 1 (foundation — must go first):
  - Install pino + pino-pretty
  - Create src/lib/logger.ts
  - Create generation_log table via Supabase MCP

Phase 2 (depends on Phase 1):
  - Update base-agent.ts (needs logger.ts)
  - Update pipeline.worker.ts (needs logger.ts + correlationId)
  - Update API clients (needs logger.ts)

Phase 3 (depends on Phase 2):
  - Update all 6 agent files (needs base-agent changes)
  - Update all API routes (needs logger.ts)
```

**Recommendation:** Single backend agent, executed sequentially in 3 phases. Too many shared files for parallel dispatch — `base-agent.ts`, `logger.ts`, and the worker are touched across multiple phases.

## Consumer: Debugger Agent

The `debugger` sub-agent (`.claude/skills/debugger/SKILL.md`) is the primary consumer of this observability data. It uses:
- `generation_log` table queries to build pipeline timelines and find failure points
- `correlation_id` to filter all events for a single pipeline execution
- API call audit entries to identify external service failures
- The structured `detail` JSONB column for latency, cost, and error analysis

The debugger agent is **read-only** — it queries data and proposes fixes but never modifies code or data.

## Out of Scope

- Frontend log viewer / generation_log UI (future feature)
- Log shipping to external services (Datadog, etc.) — JSON output is enough for now
- OpenTelemetry / distributed tracing spans
- Database query logging
- Performance dashboards
