# R1.7 - B-Roll Agent Design

**Date:** 2026-02-15
**Status:** APPROVED
**Priority:** P0 - Critical (Tier 1)
**Effort:** Medium-Large

---

## Problem Statement

The current pipeline produces videos with only influencer keyframe footage â€” a single visual layer. High-performing TikTok Shop content uses **B-roll inserts** (supplementary images/footage cut into the main video) to maintain viewer attention, validate claims, and drive conversions. Without B-roll, generated videos look flat and monotonous, leading to scroll-away.

B-roll is not decoration â€” it's a **visual argument** that reinforces the script's persuasion structure.

## Solution

A two-phase B-Roll Agent that:
1. **Plans** a shot list during script review (before any generation happens)
2. **Generates** the approved shots as still images after directing completes

Users interact with B-roll through a **storyboard view** that maps script text, B-roll inserts, and keyframe placeholders to a 60-second timeline.

---

## Design Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Planning vs generation timing | Plan at script review, generate after directing | User sees the full visual plan early; expensive generation happens late |
| B-roll format | Still images (Nano Banana Pro) | $0.07/image vs $1.20/video clip. EditorAgent adds Ken Burns effect for motion |
| Category system | Category-aware presets (10 product categories) | Supplements get transformation/research shots; tech gets unboxing/comparison shots |
| Shot density | Scales with syllable count per segment | Optimized for ~2-3s cut frequency (short-form virality best practice) |
| Planning UX | Storyboard timeline view | Visual timeline showing script + B-roll + keyframe placeholders together |
| Image source | AI-generated + user upload override | AI handles default generation; user can replace any shot with their own image |

---

## Architecture

### Two-Phase Agent

```
PHASE 1: PLANNING (triggered when user approves script)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  User clicks "Approve Script"
    â†’ Pipeline status: 'broll_planning'
    â†’ B-RollAgent.plan(projectId)
        â†’ Reads: approved script segments (script_text, syllable_count, shot_scripts, section)
        â†’ Reads: product category, product data, product image
        â†’ Selects BROLL_PRESET for product category
        â†’ Calculates shot count per segment: ceil(syllable_count / 20) â‰ˆ 4-5 per segment
        â†’ Generates shot list via LLM:
            For each segment, produce B-roll shots with:
            - category (from preset)
            - prompt (photorealistic image generation prompt)
            - narrative_role (why this shot strengthens the argument)
            - timing_seconds (when in the 15s segment this insert appears)
            - duration_seconds (2-3s per insert)
        â†’ Saves shots to `broll_shot` table (status: 'planned')
    â†’ Pipeline status: 'broll_review'
    â†’ User sees storyboard view, edits/approves shot list

PHASE 2: GENERATION (triggered after directing + voiceover complete)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Directing + voiceover complete
    â†’ Pipeline status: 'broll_generation'
    â†’ B-RollAgent.generate(projectId)
        â†’ Reads: approved shot list from `broll_shot` table
        â†’ For each shot where source = 'ai_generated' and status = 'planned':
            â†’ Generate image via Nano Banana Pro (9:16 vertical, photorealistic)
            â†’ Create `asset` record (type: 'broll')
            â†’ Update broll_shot with image_url, asset_id, status: 'completed'
        â†’ Skip shots where source = 'user_uploaded' (already have image_url)
    â†’ Pipeline status: 'asset_review' (merged with existing asset review)
```

### Updated Pipeline Flow

```
analyzing â†’ analysis_review â†’ scripting â†’ script_review
                                              â†“
                                        broll_planning â†’ broll_review â†’ influencer_selection
                                              â†“
                                        casting â†’ casting_review â†’ directing â†’ voiceover
                                              â†“
                                        broll_generation â†’ asset_review â†’ editing â†’ completed
```

**New statuses added:** `broll_planning`, `broll_review`, `broll_generation`

**Key flow changes:**
- Script approval triggers B-roll planning (not influencer selection directly)
- After B-roll review, user proceeds to influencer selection (existing gate)
- After voiceover completes, B-roll generation runs before asset review
- Asset review now shows keyframes + videos + audio + B-roll images together

---

## ScriptingAgent Integration: B-Roll Timing Cues

The ScriptingAgent must produce **B-roll timing cues** as part of its script output. These cues tell the B-Roll Agent and EditorAgent exactly when B-roll inserts should appear in the final video.

### New field on `scene` table: `broll_cues`

```typescript
// Added to scene record (alongside shot_scripts, audio_sync, etc.)
broll_cues: Array<{
  shot_script_index: number,     // Which 5s shot block (0, 1, or 2)
  offset_seconds: number,        // Offset within the 15s segment (e.g., 1.5, 6.0, 11.5)
  duration_seconds: number,      // How long the B-roll stays on screen (2-3s)
  intent: string,                // What the B-roll should communicate (e.g., "show clinical evidence")
  spoken_text_during: string,    // The exact script text being spoken while B-roll is on screen
}>
```

### How ScriptingAgent generates cues

When writing each 15-second segment, the ScriptingAgent already produces `shot_scripts` (3 blocks of ~5s) and `audio_sync` (peak word timestamps). Now it also produces `broll_cues`:

1. **Analyze the script text** for claims, proof points, product mentions, emotional beats
2. **Mark insertion points** where a visual cutaway would strengthen the argument
3. **Time the cues** to land on sentences where the viewer's attention needs refreshing (~every 2-3s)
4. **Describe intent** so the B-Roll Agent knows what kind of image to generate
5. **Capture the spoken text** so the EditorAgent knows what audio plays under the B-roll

### Example output

```json
{
  "segment_index": 0,
  "section": "Hook",
  "script_text": "You've been lied to about collagen. Every brand claims their peptides...",
  "syllable_count": 87,
  "shot_scripts": [...],
  "audio_sync": {...},
  "broll_cues": [
    {
      "shot_script_index": 0,
      "offset_seconds": 1.0,
      "duration_seconds": 2.5,
      "intent": "negative contrast â€” show cheap generic alternatives",
      "spoken_text_during": "You've been lied to about collagen"
    },
    {
      "shot_script_index": 1,
      "offset_seconds": 5.5,
      "duration_seconds": 2.0,
      "intent": "transformation proof â€” subtle before/after",
      "spoken_text_during": "Every brand claims their peptides are different"
    },
    {
      "shot_script_index": 1,
      "offset_seconds": 8.0,
      "duration_seconds": 2.5,
      "intent": "transformation proof â€” second angle",
      "spoken_text_during": "but most use the cheapest marine collagen"
    },
    {
      "shot_script_index": 2,
      "offset_seconds": 11.5,
      "duration_seconds": 3.0,
      "intent": "research evidence â€” academic paper with data",
      "spoken_text_during": "here's what the research actually shows"
    }
  ]
}
```

### Data flow: Script â†’ B-Roll â†’ Editor

```
ScriptingAgent                  B-RollAgent                   EditorAgent
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Writes broll_cues          â†’   Reads cues
(timing + intent)              Maps to category presets
                               Generates prompts
                               User reviews/edits         â†’  Reads approved broll_shots
                                                             Gets timing from broll_cues
                                                             Composites B-roll at exact
                                                             offset_seconds with
                                                             duration_seconds
                                                             Applies Ken Burns effect
```

The `broll_cues` from the ScriptingAgent are the **timing blueprint**. The B-Roll Agent fills in the visual content (category, prompt, image). The EditorAgent uses both to place B-roll at the exact right moments in the final video.

---

## Data Model

### New `broll_shot` table

| Column | Type | Description |
|--------|------|-------------|
| `id` | uuid (PK) | Auto-generated |
| `project_id` | uuid FK | Links to project |
| `script_id` | uuid FK | Links to approved script |
| `segment_index` | integer | Which segment (0-3) |
| `shot_index` | integer | Order within segment (0-based) |
| `category` | text | B-roll category (transformation, research, lifestyle, social_proof, unboxing, comparison, etc.) |
| `prompt` | text | Photorealistic image generation prompt |
| `narrative_role` | text | Why this shot exists in the persuasion structure |
| `timing_seconds` | numeric | Offset within the 15s segment where this insert appears |
| `duration_seconds` | numeric | How long the insert stays on screen (typically 2-3s) |
| `source` | text | `ai_generated` or `user_uploaded` |
| `image_url` | text | Final image URL (populated after generation or upload) |
| `status` | text | `planned` / `generating` / `completed` / `replaced` / `removed` |
| `asset_id` | uuid FK | Links to asset record after generation (nullable) |
| `metadata` | jsonb | Provider-specific data, original prompt if edited, etc. |
| `created_at` | timestamptz | Auto-set |
| `updated_at` | timestamptz | Auto-set on update |

### New asset type

Add `broll` to the asset type enum:
- `keyframe_start`, `keyframe_end`, `video`, `audio`, `final_video`, **`broll`**

### B-roll asset metadata schema

```typescript
{
  segment_index: number,
  shot_index: number,
  category: string,
  timing_seconds: number,
  duration_seconds: number,
  ken_burns_direction: string  // 'zoom_in' | 'zoom_out' | 'pan_left' | 'pan_right' (for EditorAgent)
}
```

---

## B-Roll Category Presets

### `BROLL_PRESETS` constant (src/lib/constants.ts)

Each product category gets a tailored set of B-roll categories with shot descriptions and prompt templates.

```typescript
BROLL_PRESETS = {
  supplements: {
    categories: ['transformation', 'research', 'lifestyle', 'social_proof'],
    transformation: {
      description: 'Before/after comparisons showing subtle, believable improvements',
      shot_template: 'Split-screen before/after comparison showing {improvement_area}, natural indoor lighting, neutral background, no makeup or filter differences, photorealistic, 9:16 vertical',
      areas: ['face', 'hair', 'nails', 'skin tone', 'under-eye', 'hands'],
      typical_count: 'scale',  // scales with syllables
      narrative_role: 'Cumulative visual proof stacked throughout'
    },
    research: {
      description: 'Academic papers and clinical studies on wooden desks',
      shot_template: 'Photograph of printed academic paper on wooden desk, visible annotations, {detail}, reading glasses nearby, warm ambient lighting, photorealistic, 9:16 vertical',
      details: ['highlighted paragraphs with yellow marker', 'pen circles around key data', 'sticky tabs on page edges', 'handwritten margin notes'],
      typical_count: 3-4,
      narrative_role: 'Validates problem/solution claims with scientific authority'
    },
    lifestyle: {
      description: 'Product usage moments with casual home aesthetic',
      shot_template: '{action}, natural ring light, casual home kitchen/bathroom aesthetic, clean countertop, photorealistic, 9:16 vertical',
      actions: ['close-up of powder scoop being lifted from container', 'coffee pour with supplement being mixed in', 'hero product shot with morning light'],
      typical_count: 2-3,
      narrative_role: 'Anchors product in relatable daily routine'
    },
    social_proof: {
      description: 'Negative contrast with cheap alternatives',
      shot_template: '{scene}, harsh fluorescent lighting, photorealistic, 9:16 vertical',
      scenes: ['generic supplement bottles crowded on pharmacy shelf', 'cluttered Amazon listing screenshots'],
      typical_count: 1,
      narrative_role: 'Creates negative contrast to elevate the featured product'
    }
  },
  skincare: {
    categories: ['transformation', 'texture', 'routine', 'ingredients'],
    // ... tailored to skincare
  },
  fitness: {
    categories: ['transformation', 'action', 'setup', 'results'],
    // ... tailored to fitness
  },
  tech: {
    categories: ['unboxing', 'comparison', 'setup', 'specs'],
    // ... tailored to tech
  },
  kitchen: {
    categories: ['cooking', 'before_after', 'ingredients', 'plating'],
    // ... tailored to kitchen
  },
  fashion: {
    categories: ['styling', 'detail', 'lifestyle', 'comparison'],
    // ... tailored to fashion
  },
  home: {
    categories: ['transformation', 'detail', 'lifestyle', 'space'],
    // ... tailored to home
  },
  baby: {
    categories: ['safety', 'usage', 'comparison', 'lifestyle'],
    // ... tailored to baby
  },
  pet: {
    categories: ['reaction', 'before_after', 'ingredients', 'lifestyle'],
    // ... tailored to pet
  },
  finance: {
    categories: ['data', 'comparison', 'lifestyle', 'results'],
    // ... tailored to finance
  }
}
```

### Shot Count Formula

```typescript
function calculateBrollCount(syllableCount: number): number {
  // Target: 1 B-roll insert every ~20 syllables (~3.5 seconds of speech)
  // Minimum 2 per segment, maximum 6
  return Math.min(6, Math.max(2, Math.ceil(syllableCount / 20)));
}

// Examples:
// 82 syllables â†’ 5 shots (cut every ~3s)
// 90 syllables â†’ 5 shots
// 75 syllables â†’ 4 shots
// 60 syllables â†’ 3 shots
```

### Narrative Arc Mapping

B-roll categories map to script sections following a persuasion arc:

| Section | Primary B-roll | Purpose |
|---------|---------------|---------|
| Hook (Seg 0) | social_proof / contrast | Grab attention with unexpected visual |
| Problem (Seg 1) | research / data / evidence | Validate the problem with authority |
| Solution (Seg 2) | transformation / results | Show proof that the solution works |
| CTA (Seg 3) | lifestyle / product hero | Anchor product in daily life, close with aspiration |

---

## Storyboard View

### Layout

Vertical scrolling timeline divided into 4 segments. Each segment shows:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HOOK Â· 0:00-0:15 Â· 87 syllables Â· 4 B-roll shots            â”‚
â”‚  Estimated cost: $0.28                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚  â”Œâ”€ Shot 1 (0:00-0:05) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Script: "You've been lied to about collagen..."           â”‚ â”‚
â”‚  â”‚                                                           â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”‚ â”‚
â”‚  â”‚  â”‚ ğŸ–¼ï¸ B-roll â”‚  [Social Proof] Pharmacy shelf            â”‚ â”‚
â”‚  â”‚  â”‚ @0:01   â”‚  "Generic collagen bottles on pharmacy..."   â”‚ â”‚
â”‚  â”‚  â”‚ 2.5s    â”‚  Narrative: Negative contrast                â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  [Edit] [Replace] [Remove]                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€ Shot 2 (0:05-0:10) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Script: "Every brand claims their peptides are..."        â”‚ â”‚
â”‚  â”‚                                                           â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚ â”‚
â”‚  â”‚  â”‚ ğŸ–¼ï¸ B-roll â”‚  â”‚ ğŸ–¼ï¸ B-roll â”‚  [Transformation] Face     â”‚ â”‚
â”‚  â”‚  â”‚ @0:05   â”‚  â”‚ @0:07   â”‚  Split-screen before/after     â”‚ â”‚
â”‚  â”‚  â”‚ 2s      â”‚  â”‚ 2.5s    â”‚                                â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  [Edit] [Replace] [Remove]     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€ Shot 3 (0:10-0:15) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Script: "But here's what the research actually..."        â”‚ â”‚
â”‚  â”‚                                                           â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”‚ â”‚
â”‚  â”‚  â”‚ ğŸ–¼ï¸ B-roll â”‚  [Research] Academic paper on desk         â”‚ â”‚
â”‚  â”‚  â”‚ @0:11   â”‚  "Printed paper with highlighted..."         â”‚ â”‚
â”‚  â”‚  â”‚ 3s      â”‚                                              â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  [Edit] [Replace] [Remove]                   â”‚ â”‚
â”‚  â”‚                                                           â”‚ â”‚
â”‚  â”‚  [+ Add B-roll to this shot]                              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  PROBLEM Â· 0:15-0:30 Â· 84 syllables Â· 5 B-roll shots         â”‚
â”‚  ...                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### User Actions on Storyboard

| Action | Description |
|--------|-------------|
| **Edit prompt** | Click on B-roll prompt text to edit the image generation prompt |
| **Change category** | Dropdown to switch B-roll category (e.g., research â†’ transformation) |
| **Replace with upload** | Upload own image to replace any B-roll shot |
| **Remove shot** | Delete a B-roll from the timeline |
| **Add shot** | Insert a new B-roll at a specific shot position |
| **Reorder** | Drag shots within a segment to change timing |
| **Adjust timing** | Change when in the segment the B-roll appears and how long it stays |
| **Regenerate prompt** | Ask the LLM to re-propose a prompt for this slot |

### Storyboard Summary Bar

Fixed bar at top/bottom showing:
- Total B-roll count: `14 shots`
- Estimated generation cost: `$0.98`
- Per-category breakdown: `5 transformation Â· 3 research Â· 4 lifestyle Â· 2 social proof`
- [Approve & Continue] button

---

## B-Roll Planning LLM Prompt

The B-Roll Agent sends a structured prompt to WaveSpeed LLM:

```
You are a TikTok content strategist specializing in B-roll planning for
short-form product videos. Your job is to create a B-roll shot list that
maximizes viewer retention and conversion.

PRODUCT: {product_name} ({product_category})
PRODUCT DESCRIPTION: {product_data summary}
PRODUCT IMAGE: {product_image_url}

SCRIPT SEGMENTS:
Segment 0 (Hook, {syllable_count} syllables):
  Shot 1 (0-5s): "{shot_scripts[0].text}"
  Shot 2 (5-10s): "{shot_scripts[1].text}"
  Shot 3 (10-15s): "{shot_scripts[2].text}"
[...repeat for segments 1-3]

B-ROLL PRESET for {product_category}:
Categories: {preset.categories}
{category descriptions and shot templates}

TARGET SHOT COUNT PER SEGMENT:
  Segment 0: {calculated_count} shots
  Segment 1: {calculated_count} shots
  ...

RULES:
1. Every B-roll image must be photorealistic with static camera, 9:16 vertical aspect ratio
2. B-roll inserts should create visual variety every 2-3 seconds
3. Each shot must have a clear narrative_role explaining how it strengthens the persuasion
4. Follow the narrative arc: contrast in hook, evidence in problem, proof in solution, aspiration in CTA
5. Never obscure the product in segments where product_visibility is 'hero' or 'set_down'
6. Transformation shots must show subtle, believable improvements (no dramatic/fake changes)
7. Research shots must look authentic (real papers, real annotations, real lighting)
8. Include specific details in prompts (lighting, surface, props, angle)

OUTPUT: JSON array of broll shots with:
  segment_index, shot_index, category, prompt, narrative_role, timing_seconds, duration_seconds
```

---

## API Endpoints

| Method | Route | Description |
|--------|-------|-------------|
| `GET` | `/api/projects/[id]/broll` | List all B-roll shots for a project |
| `POST` | `/api/projects/[id]/broll/plan` | Trigger B-roll planning (auto-called on script approval) |
| `PATCH` | `/api/projects/[id]/broll/[shotId]` | Edit a B-roll shot (prompt, category, timing, etc.) |
| `DELETE` | `/api/projects/[id]/broll/[shotId]` | Remove a B-roll shot |
| `POST` | `/api/projects/[id]/broll/add` | Add a custom B-roll shot |
| `POST` | `/api/projects/[id]/broll/[shotId]/upload` | Upload user image to replace a shot |
| `POST` | `/api/projects/[id]/broll/[shotId]/regenerate-prompt` | Re-generate prompt for a single shot via LLM |
| `POST` | `/api/projects/[id]/broll/approve` | Approve shot list â†’ status to influencer_selection |

---

## Cost Impact

| Component | Cost per video |
|-----------|---------------|
| B-roll planning (1 LLM call) | $0.01 |
| 12-16 B-roll images @ $0.07 | $0.84-1.12 |
| **Total B-roll addition** | **~$0.85-1.13** |
| Previous pipeline total | $5.58 |
| **New total per video** | **~$6.43-6.71** |

~15-20% cost increase for significantly richer, higher-converting content.

---

## Acceptance Criteria

### ScriptingAgent
- [ ] Add `broll_cues` field to scene table (Supabase migration)
- [ ] ScriptingAgent generates `broll_cues` per segment: `{ shot_script_index, offset_seconds, duration_seconds, intent, spoken_text_during }`
- [ ] ScriptingAgent LLM prompt updated to produce B-roll timing cues alongside existing shot_scripts and audio_sync
- [ ] B-roll cues timed to refresh visuals every ~2-3 seconds based on syllable density
- [ ] Cues include the exact spoken text that plays under each B-roll insert (for EditorAgent sync)

### Backend
- [ ] `broll_shot` table created via Supabase migration
- [ ] `broll` added as valid asset type
- [ ] B-RollAgent class extending BaseAgent with `plan()` and `generate()` methods
- [ ] B-RollAgent.plan() reads `broll_cues` from scenes to pre-populate timing and intent
- [ ] `BROLL_PRESETS` constant with all 10 product category presets
- [ ] Shot count formula: `ceil(syllable_count / 20)`, min 2, max 6 per segment
- [ ] Pipeline worker handles `broll_planning` and `broll_generation` steps
- [ ] New statuses added: `broll_planning`, `broll_review`, `broll_generation`
- [ ] Script approval triggers B-roll planning (updated approve route)
- [ ] B-roll approval transitions to `influencer_selection`
- [ ] After voiceover â†’ `broll_generation` â†’ `asset_review`
- [ ] B-roll CRUD API endpoints (list, edit, delete, add, upload, regenerate-prompt, approve)
- [ ] User upload stores in Supabase Storage (`assets/broll/{projectId}/{shotId}/`)
- [ ] Cost tracking for planning LLM call + image generation

### Frontend
- [ ] Storyboard view component with 60-second vertical timeline
- [ ] Per-segment sections showing shot_scripts text + B-roll cards
- [ ] B-roll card: category badge, prompt text, timing, duration, narrative role
- [ ] Edit prompt inline
- [ ] Change category dropdown
- [ ] Upload image to replace shot
- [ ] Remove shot button
- [ ] Add shot button per shot_script section
- [ ] Drag to reorder within segment
- [ ] Adjust timing/duration
- [ ] Summary bar: total count, estimated cost, per-category breakdown
- [ ] Approve button â†’ transitions to influencer_selection
- [ ] B-roll images shown in asset_review alongside keyframes, videos, audio
- [ ] Loading/generating states during Phase 2

### Integration
- [ ] EditorAgent reads `broll_cues` (from scene) + `broll_shot` records to place B-roll at exact `offset_seconds` with correct `duration_seconds`
- [ ] EditorAgent uses `spoken_text_during` from cues to verify audio-visual sync
- [ ] Ken Burns effect metadata (zoom direction, speed) passed to EditorAgent per B-roll shot
- [ ] EditorAgent composites B-roll as overlay/cutaway layer on the video timeline
- [ ] Asset review shows B-roll images grouped by segment alongside other assets
- [ ] B-roll shots included in `completed_run` archive
- [ ] Storyboard timestamps survive through the full pipeline: ScriptingAgent â†’ B-RollAgent â†’ EditorAgent

---

## Parallel Work Analysis

```
PARALLEL WORK ANALYSIS:

- Task A0 (backend): ScriptingAgent update â€” add broll_cues to scene schema + LLM prompt
  Files: Supabase migration (scene.broll_cues), src/agents/scripting-agent.ts
  Independent: YES (no dependency on broll_shot table)

- Task A1 (backend): broll_shot table migration + BROLL_PRESETS constant + shot count formula
  Files: Supabase migration, src/lib/constants.ts
  Independent: YES (can run in parallel with A0)

- Task B (backend): B-RollAgent class (plan + generate methods)
  Files: src/agents/broll-agent.ts
  BLOCKED by Task A0 + A1 (needs broll_cues from scene + broll_shot table + constants)

- Task C (backend): Pipeline worker updates (new statuses, step handlers)
  Files: src/workers/pipeline.worker.ts, src/lib/constants.ts
  BLOCKED by Task B (needs agent)

- Task D (backend): B-roll API endpoints (CRUD + upload + approve)
  Files: src/app/api/projects/[id]/broll/**
  BLOCKED by Task A1 (needs table)

- Task E (frontend): Storyboard view component
  Files: src/components/storyboard-view.tsx (NEW)
  PARTIALLY BLOCKED by Task D (needs API, but can build with mocked data)

- Task F (backend): Approve route update (script approval â†’ broll_planning)
  Files: src/app/api/projects/[id]/approve/route.ts
  BLOCKED by Task C (needs pipeline changes)

- Task G (frontend): Asset review B-roll integration
  Files: src/components/asset-review.tsx
  BLOCKED by Task D + E (needs API + storyboard patterns)

Recommendation:
  Step 1: Task A0 + Task A1 in parallel (ScriptingAgent cues + broll_shot table + constants)
  Step 2: Task B + Task D in parallel (agent + API endpoints) â€” both need migrations
  Step 3: Task C + Task E in parallel (pipeline + storyboard UI shell)
  Step 4: Task F + Task G (approve route + asset review integration)
```
